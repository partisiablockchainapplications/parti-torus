TODO: refactor code between single and multithreaded mod to not have a bunch of duplicate code